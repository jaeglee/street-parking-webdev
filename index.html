<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Street Parking Prediction</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <style>
    :root { --right-bg: #f6f7f9; }
    html, body { height: 100%; margin: 0; }
    .split { display: flex; height: 100vh; width: 100vw; }
    .left  { position: relative; flex: 0 0 66%; min-width: 320px; overflow: hidden; background: #ddd; }
    .right { flex: 1 1 34%;  min-width: 320px; background: var(--right-bg); display: flex; flex-direction: column; }
    #map { position: absolute; inset: 0; }

    /* Title box */
    .title-box {
      position: absolute; top: 20px; right: 20px;
      background: rgba(0,0,0,0.6); color: #fff;
      padding: 12px 16px; border-radius: 8px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: 500px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .title-box h1 { font-size: 20px; margin: 0 0 4px; font-weight: 700; }
    .title-box p { margin: 2px 0; font-size: 14px; line-height: 1.3; }

    /* Legend */
    .legend {
      position: absolute; top: 20px; left: 20px;
      background: rgba(255,255,255,0.9); padding: 10px;
      border-radius: 6px; font: 13px system-ui;
      box-shadow: 0 1px 2px rgba(0,0,0,.25);
    }
    .legend div { display: flex; align-items: center; gap: 6px; margin-top: 4px; }
    .legend span { width: 14px; height: 14px; border-radius: 2px; display: inline-block; }

    /* Right panel content */
    .panel-header {
      padding: 12px 16px; border-bottom: 1px solid #e3e6ea; font: 14px system-ui;
      color: #333; background: #fff;
    }
    .panel-header b { font-weight: 600; }
    .panel-body {
      padding: 12px 16px; overflow: auto; flex: 1 1 auto;
      font: 13px system-ui; color: #333;
    }
    .gallery {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 10px;
    }
    .card {
      background: #fff; border-radius: 8px; overflow: hidden;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08); border: 1px solid #e6e6e6;
    }
    .card img { width: 100%; height: 120px; object-fit: cover; display: block; }
    .card .meta { padding: 6px 8px; font-size: 12px; color: #555; }
    .muted { color: #777; }
  </style>
</head>
<body>
  <div class="split">
    <!-- LEFT: Map panel -->
    <div class="left">
      <div id="map"></div>

      <!-- Overlay: Legend -->
      <div class="legend">
        <strong>Predicted Parking (lines)</strong>
        <div><span style="background:#07ed41"></span> Parking</div>
        <div><span style="background:#fb1313"></span> No Parking</div>
        <p></p>
        <p></p>
        <strong>Validation Points (circles)</strong>
        <div><span style="background:#228ffc"></span> Parking</div>
        <div><span style="background:#e81efa"></span> No Parking</div>

      </div>
    </div>

    <!-- RIGHT: Images panel -->
    <div class="right">
      <!-- Overlay: Title -->
      <div class="title-box">
        <h1>Street Parking Prediction in Atlanta</h1>
        <p>Jaegeon Lee, Uijeong Hwang, Subhrajit Guhathakurta</p>
        <p>Georgia Institute of Technology</p>
      </div>

      <div class="panel-header">
        <div>Images for edge_side_id: <b id="panel-id">—</b></div>
        <div class="muted" id="panel-sub">Click a line segment to load images from GitHub.</div>
      </div>
      <div class="panel-body">
        <div id="gallery" class="gallery"></div>
      </div>
    </div>
  </div>

  <script>
    // === Map setup ===
    mapboxgl.accessToken = 'pk.eyJ1IjoiamFlZ2xlZSIsImEiOiJjbWU5eWJja3Ewdm12Mm1wcmp2M2Y0MXN2In0.fL8YFWQZqsmeS2coJtnGZw'; // for public
    const map = new mapboxgl.Map({
      container: 'map',
      //style: 'mapbox://styles/mapbox/light-v11',
      // style: 'mapbox://styles/mapbox/streets-v12',
      style: 'mapbox://styles/mapbox/dark-v11',
      // style: 'mapbox://styles/mapbox/satellite-v9',
      //style: 'mapbox://styles/jaeglee/cmdqr0yl8000z01s817qt0f2a',
      center: [-84.41167689058845, 33.7610313634532], 
      zoom: 10.7,
      minZoom: 7
    });

    const popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false, offset: [0, -8] });
    const labelForPredicted = v => (v === 1 || v === '1') ? 'Parking' : 'No parking';

    map.on('load', () => {
      let hoveredId = null;


      // 1. Background (atl)
      map.addSource('bg-atl', {
        type: 'vector',
        url: 'mapbox://jaeglee.5n5kcsh7'
      });

      map.addLayer({
        id: 'bg-atl',
        type: 'fill',
        source: 'bg-atl',
        'source-layer': 'atl-23a1qm',
        paint: {
          'fill-color': '#000000',
          'fill-opacity': 0.2
        }
      }); 
      map.addLayer({
        id: 'bg-atl-line',
        type: 'line',
        source: 'bg-atl',
        'source-layer': 'atl-23a1qm',
        paint: {
          'line-color': '#f7f7f7',
          'line-opacity': 0.5,
          'line-width': [
            'interpolate', ['linear'], ['zoom'],
            10, 2,   
            12, 4,   
            14, 5,
            16, 6   
          ],
        }
      }); 

      // 2. Background (mid)
      map.addSource('bg-mid', {
        type: 'vector',
        url: 'mapbox://jaeglee.9nfudyuy'
      });

      map.addLayer({
        id: 'bg-mid',
        type: 'line',
        source: 'bg-mid',
        'source-layer': 'case_study_area_mid-bfobte',
        paint: {
          'line-color': '#f7f7f7',
          'line-opacity': 0.5,
          'line-width': [
            'interpolate', ['linear'], ['zoom'],
            10, 2,   
            12, 4,   
            14, 5,
            16, 6   
          ],
        }
      }); 

      // 3. Ground truth (parkopedia)
      map.addSource('gt-parkopedia', {
        type: 'vector',
        url: 'mapbox://jaeglee.5g1ay11j'
      });

      map.addLayer({
        id: 'gt-parkopedia',
        type: 'circle',
        source: 'gt-parkopedia',
        'source-layer': 'parkopedia_df_centroid-18919y',
        paint: {
          'circle-radius': [
            'interpolate', ['linear'], ['zoom'],
            10, 0.5,   
            12, 1,   
            14, 6,
            16, 8   
          ],
          'circle-color': '#228ffc',
          'circle-opacity': 1.0
        }
      }); 

      // 4. Ground truth (firsthand)
      map.addSource('gt-firsthand', {
        type: 'vector',
        url: 'mapbox://jaeglee.b7gmbs7q'
      });

      map.addLayer({
        id: 'gt-firsthand',
        type: 'circle',
        source: 'gt-firsthand',
        'source-layer': 'groundtruth_df_wo_parkopedia_-4eo8b0',
        paint: {
          'circle-radius': [
            'interpolate', ['linear'], ['zoom'],
            10, 0.5,   
            12, 1,   
            14, 6,
            16, 8   
          ],
          'circle-opacity': 1,
          'circle-color': [
            'case',
            ['==', ['get', 'ground_truth_avail'], 1], '#228ffc',
            '#e81efa'
          ],
        }
      }); 


      // 5. Prediction (prediction_df)
      map.addSource('prediction_df_runtime', {
        type: 'vector',
        url: 'mapbox://jaeglee.1jptfmqr',
        promoteId: 'edge_side_id', // important for feature-state by ID
      });

      map.addLayer({
        id: 'prediction_df_runtime',
        type: 'line',
        source: 'prediction_df_runtime',
        'source-layer': 'prediction_df-4w80nb',
        paint: {
          'line-color': [
            'case',
            ['==', ['get', 'predicted_avail'], 1], '#07ed41',
            '#fb1313'
          ],
          'line-width': [
            'interpolate', ['linear'], ['zoom'],
            10, ['case', ['boolean', ['feature-state', 'hover'], false], 2.0, 0.7],
            12, ['case', ['boolean', ['feature-state', 'hover'], false], 3.5, 1.0],
            14, ['case', ['boolean', ['feature-state', 'hover'], false], 6, 2],
            16, ['case', ['boolean', ['feature-state', 'hover'], false], 6, 3]
          ],
          'line-opacity': 0.9
        },
        layout: { 'line-join': 'round', 'line-cap': 'round' }
      });

      // events
      map.on('mouseenter', 'prediction_df_runtime', () => {
        map.getCanvas().style.cursor = 'pointer';
      });

      map.on('mousemove', 'prediction_df_runtime', (e) => {
        if (!e.features?.length) return;

        // clear previous state
        if (hoveredId !== null) {
          map.setFeatureState(
            { source: 'prediction_df_runtime', sourceLayer: 'prediction_df-4w80nb', id: hoveredId },
            { hover: false }
          );
        }

        const f = e.features[0];
        // with promoteId, Mapbox assigns feature.id automatically
        const id = f.id ?? f.properties?.edge_side_id;
        if (id == null) return;

        hoveredId = id;
        map.setFeatureState(
          { source: 'prediction_df_runtime', sourceLayer: 'prediction_df-4w80nb', id },
          { hover: true }
        );

        // your popup code can stay the same
        const p = f.properties || {};
        const html = `
          <div style="font:12px/1.3 system-ui;">
            <div><strong>${(p.predicted_avail==1||p.predicted_avail==='1')?'Parking':'No parking'}</strong></div>
            <div>Edge-side ID: ${p.edge_side_id ?? '—'}</div>
            <div>Permit: ${p.permit ?? '—'}</div>
            <div>Detected vehicle: ${p.detectedVehicle ?? '—'}</div>
          </div>`;
        popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
      });

      map.on('mouseleave', 'prediction_df_runtime', () => {
        map.getCanvas().style.cursor = '';
        popup.remove();
        if (hoveredId !== null) {
          map.setFeatureState(
            { source: 'prediction_df_runtime', sourceLayer: 'prediction_df-4w80nb', id: hoveredId },
            { hover: false }
          );
          hoveredId = null;
        }
      });

      map.on('click', 'prediction_df_runtime', (e) => {
        const id = e.features?.[0]?.properties?.edge_side_id;
        if (id) loadImagesForId(String(id));
      });
    })

    // === Right panel logic: fetch & render images from GitHub ===
    const GH_OWNER  = 'jaeglee';
    const GH_REPO   = 'street-parking-webdev';
    const GH_BRANCH = 'main';
    const FOLDERS   = ['img/detected_sign/detected_sign_sub_01', 'img/detected_sign/detected_sign_sub_02',
                       'img/detected_vehicle/detected_vehicle_sub_01', 'img/detected_vehicle/detected_vehicle_sub_02',
                       'img/detected_vehicle/detected_vehicle_sub_03', 'img/detected_vehicle/detected_vehicle_sub_04',
                       'img/detected_vehicle/detected_vehicle_sub_05', 'img/detected_vehicle/detected_vehicle_sub_06']; // add/remove as needed
    const MAX_SHOW  = 24; // cap to keep UI snappy
    const cache     = new Map(); // cache directory listings per folder

    async function listFolder(path) {
      // Cache folder listings to avoid repeated API calls
      if (cache.has(path)) return cache.get(path);

      const url = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(path)}?ref=${GH_BRANCH}`;
      const resp = await fetch(url, { headers: { 'Accept': 'application/vnd.github+json' } });
      if (!resp.ok) {
        console.warn('GitHub API error for', path, resp.status, await resp.text());
        cache.set(path, []); // cache empty to avoid retry storms
        return []; 
      }
      const data = await resp.json();
      // Keep only image files
      const files = (Array.isArray(data) ? data : []).filter(item =>
        item.type === 'file' && /\.(jpg)$/i.test(item.name)
      );
      cache.set(path, files);
      return files;
    }

    async function fetchImagesForId(edgeSideId) {
      // pattern: filenames contain "__<id>__"
      const needle = `__${edgeSideId}__`;
      const all = [];
      for (const folder of FOLDERS) {
        const files = await listFolder(folder);
        const hits  = files.filter(f => f.name.includes(needle));
        // Map to useful fields (use download_url for direct image)
        hits.forEach(f => all.push({
          name: f.name,
          download_url: f.download_url,
          html_url: f.html_url,
          folder
        }));
      }
      return all;
    }

    async function loadImagesForId(edgeSideId) {
      // Update header
      document.getElementById('panel-id').textContent = edgeSideId;
      document.getElementById('panel-sub').textContent = 'Loading images from GitHub…';

      try {
        const imgs = await fetchImagesForId(edgeSideId);
        renderGallery(edgeSideId, imgs);
      } catch (err) {
        console.error(err);
        renderError('Failed to load images from GitHub.');
      }
    }

    function renderGallery(edgeSideId, imgs) {
      const sub = document.getElementById('panel-sub');
      const gal = document.getElementById('gallery');
      gal.innerHTML = '';

      if (!imgs.length) {
        sub.textContent = `No images found for edge_side_id=${edgeSideId}.`;
        return;
      }

      sub.textContent = `${imgs.length} image(s) found. Showing up to ${Math.min(imgs.length, MAX_SHOW)}.`;
      imgs.slice(0, MAX_SHOW).forEach(it => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${it.download_url}" alt="${it.name}">
          <div class="meta">
            <div class="muted">${it.folder.replace('img/', '')}</div>
            <div style="word-break:break-all">${it.name}</div>
            <div><a href="${it.html_url}" target="_blank" rel="noopener">Open on GitHub</a></div>
          </div>`;
        gal.appendChild(card);
      });
    }

    function renderError(msg) {
      document.getElementById('panel-sub').textContent = msg;
      document.getElementById('gallery').innerHTML = '';
    }
  </script>
</body>
</html>